name: Build Project

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 有任意 package-lock.json 时启用 npm 缓存
    - name: Setup Node.js (with npm cache)
      if: ${{ hashFiles('**/package-lock.json') != '' }}
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    # 没有锁文件则不启用缓存，避免校验失败
    - name: Setup Node.js (no cache)
      if: ${{ hashFiles('**/package-lock.json') == '' }}
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # server
    - name: Install server dependencies
      if: ${{ hashFiles('server/package.json') != '' }}
      working-directory: ./server
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Build server
      if: ${{ hashFiles('server/package.json') != '' }}
      working-directory: ./server
      env:
        NODE_ENV: production
      run: npm run build

    # worker
    - name: Install worker dependencies
      if: ${{ hashFiles('worker/package.json') != '' }}
      working-directory: ./worker
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Build worker
      if: ${{ hashFiles('worker/package.json') != '' }}
      working-directory: ./worker
      env:
        NODE_ENV: production
      run: npm run build

    # artifacts（路径按你现在的构建输出保持不变；若不存在则忽略，不阻断流程）
    - name: Upload server build artifacts
      if: ${{ hashFiles('server/dist/**/*') != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: server-dist
        path: server/dist/server
        retention-days: 7
        if-no-files-found: ignore

    - name: Upload worker build artifacts
      if: ${{ hashFiles('worker/dist/**/*') != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: worker-dist
        path: worker/dist/worker
        retention-days: 7
        if-no-files-found: ignore
